//asano memo
//macro for TDC calibration
//input : output generated by evanatko, interval of calibrator, 

//TString pdfname="tgain.pdf";
//TString pdfname="tgain";
const double interval=10.;//nsec
const int nominalentry=10000;
class ConfMan;
class CounterMapMan;

void TGain(const char* tkorootfile="tkoout/tkooutchamber.root"){
  gROOT->SetBatch(kTRUE);
  gSystem->Load("lib/libAll.so");
  TGainRun74prechamber("conf/Run78/analyzer.conf",tkorootfile);
}

void CalcChamber(TFile *f,ConfMan *conf,int cr,int sl)
{
  TH1F *htko=NULL;
  TGraphErrors *gra=NULL;
  TLine line; line.SetLineColor(2);
  double peakpos[100]; // position of peaks (rough, before fit)
  double fitmean[100]; // position of peaks (by gaus fit)
  double fitsigma[100]; // sigma of peaks (by gaus fit)
  double tdiff[100];//interval * point
  double linearity[100];
  double linsigma[100];
  for( int ip=0; ip<100; ip++ ) tdiff[ip] = interval*ip; 

  TCanvas *c1 = new TCanvas( "c1", "TKO entry", 1000, 1000 );
  c1->Divide(4,4);
  TCanvas *c2 = new TCanvas( "c2", "gaus fit results", 1000, 1000 );
  c2->Divide(4,4);
  TCanvas *c3 = new TCanvas( "c3", "c3", 1000, 1000 );
  c3->Divide(4,4);
  
  int npeak=0;
  int ipad=0;
  for( int ich=0; ich<=31; ich++ ){
    npeak = 0;
    ipad++;
    c1->cd( ipad );
    htko = NULL;
    htko = (TH1F*)f->Get( Form( "TKOc%dn%da%d", cr,sl,ich ) );  
    if(htko==0){ std::cout << " NOT Found : " << cr <<" "<<sl<<" "<<ich<<std::endl; continue; } // just check
    if( (htko->GetEntries())<nominalentry) continue; 
    htko->Draw();
    int nbinx = htko->GetNbinsX();
    for( int ibin=htko->FindBin(300); ibin<htko->FindBin(4000); ibin++ ){ // search peak positions roughly (both edge of histogram are avoided)
      int content = htko->GetBinContent(ibin);
      if( 100<content ){ // at peak, content should be large enough.
        peakpos[npeak] = htko->GetBinCenter(ibin);
        line.DrawLine( peakpos[npeak], 0, peakpos[npeak], htko->GetMaximum() );
        npeak++;
        if(npeak==99) break;
        ibin += 20; // peak width is maybe smaller than 20 bins, and distance between peaks are maybe larger than 20bins.
      }
    }
    if(npeak<5){ std::cout << " # of peak is less than 5! " << cr <<" "<< sl <<" "<< ich <<std::endl; continue; }
    for( int ipeak=0; ipeak<npeak; ipeak++ ){ // fit each peak
      htko->Fit( "gaus","0q","", peakpos[ipeak]-10., peakpos[ipeak]+10. );
      fitmean[ipeak] = htko->GetFunction( "gaus" )->GetParameter(1);
      //fitsigma[i]= htko->GetFunction( "gaus" )->GetParameter(2);
      fitsigma[ipeak]= htko->GetFunction( "gaus" )->GetParError(1);
      if(fitmean[ipeak]>4000) fitmean[ipeak]=0;
    }
    htko->GetXaxis()->SetRangeUser(peakpos[0]-100,peakpos[npeak-1]+100);
    
    c2->cd( ipad );
    gra = new TGraphErrors( npeak-1, fitmean, tdiff, fitsigma, 0 );
    gra->SetTitle(Form( "TKOc%dn%da%d", cr,sl,ich ));
    //TString func="pol1";
    gra->Fit( "pol1" ,"q"); // linear fit
    
    c2->cd( ipad );
    gra->Draw("alpw");
    //Calc Residual
    double pol1para[2];
    pol1->GetParameters(pol1para);
    
    /*
    double resi[100];
    for(int i=0;i<100;i++){
      resi[i]=0;
    }
    for( int ipeak=0; ipeak<npeak; ipeak++ ){
      double y = pol1para[1]*tdiff[ipeak] +pol1para[0];
      resi[ipeak]  = y - fitmean[ipeak];
    }

    //Remove large deviated point 
    int n=0;
    for( int i=0; i<npeak; i++ ){
      if(fabs(resi[i])>1){
        gra->RemovePoint(i-n);
        std::cout << "REMOVE point i" << i << "resi " << resi[i] << std::endl; 
        n++;
      }
    }*/
    
    /*
    TF1 f2("pol2","pol2",0,4000);
    double par[3];
    gra->GetFunction("pol1")->GetParameters(par);
    par[2]=0.;
    f2.SetParameters(par);
    gra->Fit( &f2 ,"q"); // pol2 fit
    gra->Draw("alpw");
    double offs,temp1;
    //    double gain = -1./func->GetParameter(1);
    */
    c3->cd( ipad );    
    //TF1 *f1 = (TF1*)gra->GetFunction("pol1");
    //f1->SetLineColor(2);
    //f1->Draw("");
    pol1->SetLineColor(2);
    pol1->Draw();

    for( int i=0; i<npeak; i++ ){ // fit each peak
      linearity[i]=pol1->Eval(fitmean[i])-tdiff[i];
      linsigma[i]=pol1->Eval(fitmean[i]+fitsigma[i])-(pol1->Eval(fitmean[i]));
    }

    gra2 = new TGraphErrors( npeak-1 , fitmean, linearity, 0, linsigma );
    gra2->SetTitle(Form( "TKOc%dn%da%d", cr,sl,ich ));
    gra2->SetLineStyle(2);
    gra2->SetMarkerStyle(20);
    gra2->Draw("alpw");


    double p1 =-pol1->GetParameter(1);
    double p2 =-pol1->GetParameter(2);
    //if(cr==0||(cr==1&&sl>8&&sl<17)){
    //  p1*=-1;
    //  p2*=-1;
    //}
    double offs,temp1;
    conf->GetGainMapManager()->GetParam( cr,sl,ich, temp1, offs );
    conf->GetGainMapManager()->SetParam( cr,sl,ich, offs, p1, p2 ); // set a new parameter into map
    std::cout<<"cr,sl,ch,gain before -> after"<<cr<<"\t"<<sl<<"\t"<<ich<<"\t"<<temp1<<" -> "<<p1<<std::endl;
    std::ofstream ofs3("before_after_log",std::ios::out | std::ios::app);
    ofs3 <<"cr,sl,ch,gain before -> after"<<cr<<"\t"<<sl<<"\t"<<ich<<"\t"<<temp1<<" -> "<<p1<<std::endl;
    ofs3.close();
    if(ich==15||ich==31){
      ipad=0;

      //std::string pdfname = Form("TDCCalib/tcalrun74pre_peakfit_cr%dsl%d_%d_%d.pdf",cr,sl,ich-15,ich);
      //c1->SaveAs(pdfname.c_str(),"PDF");
      //std::string pdfname = Form("TDCCalib/tcalrun74pre_pol1fit_cr%dsl%d_%d_%d.pdf",cr,sl,ich-15,ich);
      //c2->SaveAs(pdfname.c_str(),"PDF");
      //std::string pdfname = Form("TDCCalib/tcalrun74pre_nanda_cr%dsl%d_%d_%d.pdf",cr,sl,ich-15,ich);
      //c3->SaveAs(pdfname.c_str(),"PDF");
      std::string pdfname = Form("TDCCalib/tcalrun74pre_peakfit_cr%dsl%d_%d_%d.png",cr,sl,ich-15,ich);
      c1->SaveAs(pdfname.c_str(),"PNG");
      std::string pdfname = Form("TDCCalib/tcalrun74pre_pol1fit_cr%dsl%d_%d_%d.png",cr,sl,ich-15,ich);
      c2->SaveAs(pdfname.c_str(),"PNG");
      std::string pdfname = Form("TDCCalib/tcalrun74pre_nanda_cr%dsl%d_%d_%d.png",cr,sl,ich-15,ich);
      c3->SaveAs(pdfname.c_str(),"PNG");
    }
  }
}

TGainchamber(const std::string conffile,const char* tkorootfile){
  
  ConfMan *conf = new ConfMan(conffile);
  conf->Initialize();

  //pdfname=Form("tgain_run74pre_chamber.pdf");
  const int ntdccr = 10;
  int cr[ntdccr]   ={ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9};
  int slini[ntdccr]={ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1};
  int slfin[ntdccr]={22,22,20,20,20,22,22,22,22,22};
  //TFile *f=new TFile(Form("root/run74/tko%d.root",1));
  TFile *f=new TFile(tkorootfile,"READ");
  if(!f->IsOpen()){std::cout << "file not found:  " << tkorootfile << std::endl;return;}
  //TCanvas *c1=new TCanvas();
  // c1->Print(pdfname+"[");
  CounterMapMan *cmapman = conf->GetCounterMapManager();
  for(int icr=0;icr<ntdccr;icr++){
    for(int isl=slini[icr];isl<=slfin[icr];isl++){

      int cid = cmapman->GetCID(icr,isl,0);//look at 1st channel
      if( cid==CID_BLC1a 
       || cid==CID_BLC1b
       || cid==CID_BLC2a
       || cid==CID_BLC2b
       || cid==CID_FDC1 
       //|| cid==CID_FDC2
       || cid==CID_BPC
       || cid==CID_CDC){
        std::cout << __FILE__ << " l." << __LINE__ << " found chamber CID "<< cid << endl;
        CalcChamber(f,conf,cr[icr],isl);
        std::cout<<"end"<<std::endl;
        //c1=new TCanvas();
        //c1->Print(pdfname+"]");
        std::cout<<"printed"<<std::endl;
        ofstream ofs("tmpbl_run74_chamber.param");
        conf->GetGainMapManager()->PrintMapBL(ofs); // print map for BeamLine
        ofstream ofs2("tmpcds_run74_chamber.param");
        conf->GetGainMapManager()->PrintMapCDS(ofs2); // print map for BeamLine
        ofs.close();
      }
    }
  }
}
