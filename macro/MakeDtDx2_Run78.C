//H.Asano
//This is a macro to make X-T curve of drift chambers used in Run78, except for CDC
//a function to make confirmation plots are added from the original macro.
//This macro requires libAll.so from k18ana.

//input : root files generated by EventAnalysisXT.cpp
//output : text files to give X-T curves of Drift chamebers, except for CDC. 

#include "TCanvas.h"
#include "TStyle.h"
#include "TH1.h"
#include "TGaxis.h"

void MakeDtDx2(int run_begin,int run_end=0){

  gSystem->Load("lib/libAll.so");
  gROOT->SetBatch();
  std::cout<<"start run: "<<run_begin<<std::endl;
  //percentage of integral of drift time distribution. 
  const double thre[]={0,0.3,2,5,10,17,25,32,
		 40,50,60,68,75,83,90,95,
		 98,99.7,100};
  
  int nthre=sizeof(thre)/sizeof(thre[0]);
  DetectorList *dlist=DetectorList::GetInstance();
  dlist->Initialize("param/Run78/Detectors.list");

  TFile *f[100];
  int nfile=run_end-run_begin+1;
  //open data
  for(int irun=run_begin;irun<=run_end;irun++){
    f[irun-run_begin]=new TFile(Form("/gpfs/group/had/knucl/e15/asano/Run78/evanaxt_%04d.root",irun),"READ");
    if(!f[irun-run_begin]->IsOpen()) return;
  }

  TTimeStamp *tm=new TTimeStamp();
  TString outname=Form("xt_%d_run%d_%d.param",tm->GetDate(),run_begin,run_end);
  if( (run_begin==run_end) || (run_end==0)){
    outname=Form("xt_%d_run%d.param",tm->GetDate(),run_begin);
  }
  ofstream ofs(outname.Data());
  const Int_t cid[6]={CID_BLC1a,CID_BLC1b,CID_BLC2a,CID_BLC2b,CID_BPC,CID_FDC1};
  
  TH1F *hdt[6][8][32];//detector, layer,wire
  TH1F *hdx[6][8][32];//detector, layer,wire
  TH1F *hdiff[6][8][32];//detector, layer,wire
  //maximum drift length
  const double dlmax[6]={4.,4.,2.5,2.5,3.0,3.0};
  for(int ic=0;ic<6;ic++){
    TH1F* hsum=NULL;
    char *name=dlist->GetName(cid[ic]).data();
    int nlayers=dlist->GetNlayers(cid[ic]);
    int nwires=dlist->GetNwires(cid[ic]);
    std::cout<<name<<"  "<<nlayers<<"  "<<nwires<<std::endl;
    ofs<<"XTParam: "<<cid[ic]<<"  "<<dlmax[ic]<<"  "<<nthre<<std::endl;
    ofs<<"Threshold: ";
    for(int i=0;i<nthre;i++){
      ofs<<thre[i]<<"  ";
    }
    ofs<<std::endl;
    for(int lay=1;lay<=nlayers;lay++){
      for(int wire=1;wire<=nwires;wire++){
        
        //drift time distribution with multiplicity cuts
        TString hname=Form("d%s_%d_%d_mul1",name,lay,wire);
        //sum up histogram from each runs
        for(int ifile=0;ifile<nfile;ifile++){
          TH1F* htemp = (TH1F*)f[ifile]->Get(hname.Data());
          if(htemp==0) continue;
          if(ifile==0) hsum = (TH1F*) htemp->Clone();
          else hsum->Add(htemp);
        }
        if(!hsum){
          std::cout<<" !!! "<<hname<<std::endl;
          continue;
        }
        //copy histogram to make a confirmation plot
        hdt[ic][lay-1][wire-1] = (TH1F*)hsum->Clone(hname.Data());
        hdx[ic][lay-1][wire-1] = new TH1F(Form("hdx_%s_%d_%d",name,lay,wire),Form("hdx_%s_%d_%d",name,lay,wire),6000,-1500,1500);
        double sum=0;
        double sumbefore=0;
        double nev=hsum->Integral();
        if(nev<1) continue;

        int iregion=0;
        double x[30]={0};
        double y[30]={0};
        double x2[1000],y2[1000];
        x[iregion]=hsum->GetBinCenter(0);
        iregion++;
        double thre_fraction=thre[iregion]/100.;
        for(int ib=0;ib<hsum->GetNbinsX();ib++){
          sumbefore=sum;
          sum += hsum->GetBinContent(ib);
          double fraction=(double)sum/(double)nev;
          hdx[ic][lay-1][wire-1]->SetBinContent(ib,sum);
          if( iregion<nthre && fraction>thre_fraction){
            if(sumbefore==sum){
              x[iregion]=hsum->GetBinCenter(ib-1); 
            }else{
              x[iregion]=(hsum->GetBinCenter(ib-1))+(hsum->GetBinWidth(ib))*(thre_fraction*nev-sumbefore)/(sum-sumbefore);
            } 
            y[iregion]=thre_fraction*dlmax[ic];//drift length
            iregion++;
            if(iregion<nthre)   thre_fraction=thre[iregion]/100.;
          }
        }
        x[iregion]=hsum->GetBinCenter(hsum->GetNbinsX()+2);
        y[iregion]=dlmax[ic];
        ofs<<std::setw(5)<<cid[ic]<<std::setw(5)<<lay<<std::setw(5)<<wire;
        ofs.setf(std::ios_base::fixed,std::ios_base::floatfield);
        for(int j=0;j<nthre;j++){
          ofs<<std::setw(8)<<std::setprecision(2)<<x[j];
        }
        ofs<<std::endl;
      }//for iwire
    }//for ilayer
  }//for ic
  ofs.close();
  //Drawing  confirmation plots
  TCanvas *c[6][8];
  for(int idc=0;idc<6;idc++){
    char *name=dlist->GetName(cid[idc]).data();
    int nlayers=dlist->GetNlayers(cid[idc]);
    int nwires=dlist->GetNwires(cid[idc]);
    for(int ilr=0;ilr<nlayers;ilr++){
      c[idc][ilr] = new TCanvas(Form("c%d_%d",idc,ilr),Form("c%d_%d",idc,ilr),800,800);
      c[idc][ilr]->Divide(4,8);
      for(int iwire=0;iwire<nwires;iwire++){
        c[idc][ilr]->cd(iwire+1);
        //hdt[idc][ilr][iwire]->SetXTitle("Drift Time [nsec.]");
        //hdt[idc][ilr][iwire]->SetYTitle("Counts/0.5 nsec.");
        hdt[idc][ilr][iwire]->Draw();
        float rightmax = 1.1*hdx[idc][ilr][iwire]->GetMaximum();
        float scale    = gPad->GetUymax()/rightmax;
        hdx[idc][ilr][iwire]->SetLineColor(kRed);
        hdx[idc][ilr][iwire]->Scale(scale);
        hdx[idc][ilr][iwire]->Draw("same");
         //draw an axis on the right side
        TGaxis *axis = new TGaxis(gPad->GetUxmax(),gPad->GetUymin(),
            gPad->GetUxmax(), gPad->GetUymax(),0,rightmax,510,"+L");
        axis->SetLineColor(kRed);
        axis->SetLabelColor(kRed);
        axis->Draw();
      }
      c[idc][ilr]->SaveAs(Form("%d_%d.png",idc,ilr));
    }
  }

  for(int irun=run_begin;irun<=run_end;irun++){
    f[irun-run_begin]->Close();
  }
  cout << "File closed" << endl;
}
